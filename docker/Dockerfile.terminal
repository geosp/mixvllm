# Minimal Terminal Server Image
# Lightweight container for running the MixVLLM web terminal server
# No GPU dependencies, CUDA, or vLLM - just the terminal interface

FROM python:3.11-slim

LABEL maintainer="Geovanny Fajardo <gffajardo@gmail.com>"
LABEL description="MixVLLM Terminal Server - Lightweight web terminal interface"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install minimal system dependencies for terminal server
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    build-essential \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Install uv (Universal Python package manager)
RUN pip install --no-cache-dir uv

# Create a non-root user with sudo privileges
RUN groupadd --gid 1000 mixvllm && \
    useradd --uid 1000 --gid 1000 --create-home --shell /bin/bash mixvllm && \
    echo "mixvllm ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/mixvllm && \
    chmod 0440 /etc/sudoers.d/mixvllm

# Create app directories and set ownership
RUN mkdir -p /app/mixvllm && chown -R mixvllm:mixvllm /app

# Set working directory
WORKDIR /app/mixvllm

# Switch to non-root user
USER mixvllm

# Set environment variables
ENV PATH=/app/mixvllm/.venv/bin:/home/mixvllm/.local/bin:${PATH}
ENV VIRTUAL_ENV=/app/mixvllm/.venv

# Copy repository contents
COPY --chown=mixvllm:mixvllm . /app/mixvllm/

# Create and populate virtual environment with only terminal dependencies
RUN cp pyproject-terminal.toml pyproject.toml && \
    uv venv && \
    uv sync && \
    rm pyproject.toml


# Make convenience scripts executable
RUN chmod +x /app/mixvllm/chat

# Add scripts to PATH
ENV PATH=${PATH}:/app/mixvllm

# Expose terminal server port
EXPOSE 8888

# Verify installation
RUN ls -la /app/mixvllm/chat && \
    echo "PATH: $PATH" && \
    python -c "import tornado, terminado; print('âœ… Terminal dependencies installed successfully')"

# Default command: run the standalone terminal server
CMD ["sh", "-c", "cd standalone/terminal && . .venv/bin/activate && python terminal_server_standalone.py --model-server-url http://localhost:8000 --host 0.0.0.0 --port 8888"]
