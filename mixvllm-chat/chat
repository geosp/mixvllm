#!/usr/bin/env bash
#
# chat â€“ launcher for the MixVLLM standalone chat client
# Always uses uv for environment management.
#
# Features:
#   * Default base-URL: http://localhost:8000
#   * Optional MCP integration via --enable-mcp
#   * Runs via `uv run` (no manual venv activation required)
#
# Usage:
#   ./chat [--base-url URL] [--enable-mcp] [--mcp-config FILE] [Other argsâ€¦]
#
set -euo pipefail

# ----------------------------------------------------------------- #
# 1. Defaults & setup                                               #
# ----------------------------------------------------------------- #
# Allow DEFAULT_BASE_URL to be overridden via the MODEL_SERVER_URL environment variable
DEFAULT_BASE_URL="${MODEL_SERVER_URL:-http://localhost:8000}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MCP_CONFIG_FILE="${SCRIPT_DIR}/app/config/mcp_servers.yaml"
APP_ENTRY="${SCRIPT_DIR}/app/chat_client.py"

# ----------------------------------------------------------------- #
# 0. Wait for healthy connection with vLLM                         #
# ----------------------------------------------------------------- #
HEALTH_URL="${DEFAULT_BASE_URL}/health"
echo "â³ Waiting for vLLM model server to become healthy at $HEALTH_URL..."

until curl -sSf "$HEALTH_URL" > /dev/null; do
    echo "ðŸ”„ Model server not ready. Retrying in 5 seconds..."
    sleep 5
done

echo "âœ… Model server is healthy. Proceeding to launch chat client."

# ----------------------------------------------------------------- #
# 2. Parse user arguments                                           #
# ----------------------------------------------------------------- #
ARGS=()
enable_mcp_provided=false

while (( $# )); do
    case "$1" in
        -h|--help)
            cat <<'EOF'
Usage: chat [--base-url URL] [--enable-mcp] [--mcp-config FILE] [Other argsâ€¦]

Options:
  --base-url URL        Override the default model server URL
  -m | --enable-mcp     Enable MCP mode (adds --mcp-config automatically)
  --mcp-config FILE     Path to the MCP config file (only used if --enable-mcp)
  -h | --help           Show this help text
EOF
            exit 0
            ;;
        --base-url)
            ARGS+=( "$1" "$2" )
            shift 2
            ;;
        -m|--enable-mcp)
            enable_mcp_provided=true
            ARGS+=( "$1" )
            shift
            ;;
        --mcp-config)
            ARGS+=( "$1" "$2" )
            shift 2
            ;;
        *)
            ARGS+=( "$1" )
            shift
            ;;
    esac
done

# ----------------------------------------------------------------- #
# 3. Inject defaults                                                #
# ----------------------------------------------------------------- #
if ! printf '%s\n' "${ARGS[@]}" | grep -q -- '--base-url'; then
    ARGS+=( "--base-url" "$DEFAULT_BASE_URL" )
fi

if $enable_mcp_provided; then
    if ! printf '%s\n' "${ARGS[@]}" | grep -q -- '--mcp-config'; then
        ARGS+=( "--mcp-config" "$MCP_CONFIG_FILE" )
    fi
fi

# ----------------------------------------------------------------- #
# 4. Launch using uv                                                #
# ----------------------------------------------------------------- #
cd "$SCRIPT_DIR"
echo "ðŸš€ Launching MixVLLM Chat via uv"
PYTHONPATH="$SCRIPT_DIR${PYTHONPATH:+:$PYTHONPATH}" \
    uv run python -m app.chat_client "${ARGS[@]}"