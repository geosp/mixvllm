<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mixvllm Web Terminal</title>

    <!-- xterm.js from CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .server-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #858585;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }

        .info-panel {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            padding: 12px 20px;
            font-size: 12px;
            line-height: 1.6;
        }

        .info-panel h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #fff;
        }

        .info-panel ul {
            margin-left: 20px;
            color: #858585;
        }

        .info-panel code {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #4fc1ff;
        }

        #terminal-container {
            flex: 1;
            padding: 10px;
            overflow: hidden;
        }

        #terminal {
            height: 100%;
            width: 100%;
        }

        .connection-status {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }

        .connection-status.connecting {
            color: #ffa500;
        }

        .connection-status.connected {
            color: #4caf50;
        }

        .connection-status.error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">üñ•Ô∏è mixvllm Web Terminal</div>
            <div class="server-info">
                <span class="status-indicator"></span>
                <span>Model Server: <strong>{{MODEL_SERVER_URL}}</strong></span>
            </div>
        </div>
    </header>

    <div class="info-panel" id="info-panel">
        <h3>üìã Quick Guide</h3>
        <ul>
            <li><code>./mixvllm-chat</code> - Start chatting with the model</li>
            <li><code>./mixvllm-chat --enable-mcp</code> - Chat with MCP tool support</li>
            <li><code>/help</code> - Show chat commands (inside chat session)</li>
            <li><code>/quit</code> - Exit chat and return to shell</li>
        </ul>
        <p style="margin-top: 8px; color: #858585;">
            üí° Tip: The terminal auto-starts with <code>./mixvllm-chat</code> for convenience.
            Press Ctrl+C to exit and use the shell normally.
        </p>
    </div>

    <div id="connection-status" class="connection-status connecting">
        Connecting...
    </div>

    <div id="terminal-container">
        <div id="terminal"></div>
    </div>

    <script>
        // Configuration from server
        const MODEL_SERVER_URL = "{{MODEL_SERVER_URL}}";
        const AUTO_START_CHAT = {{AUTO_START_CHAT}};

        // Initialize xterm.js
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: '"Cascadia Code", "Fira Code", "Consolas", "Monaco", "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
                cursor: '#ffffff',
                cursorAccent: '#1e1e1e',
                selection: 'rgba(255, 255, 255, 0.3)',
                black: '#000000',
                red: '#cd3131',
                green: '#0dbc79',
                yellow: '#e5e510',
                blue: '#2472c8',
                magenta: '#bc3fbc',
                cyan: '#11a8cd',
                white: '#e5e5e5',
                brightBlack: '#666666',
                brightRed: '#f14c4c',
                brightGreen: '#23d18b',
                brightYellow: '#f5f543',
                brightBlue: '#3b8eea',
                brightMagenta: '#d670d6',
                brightCyan: '#29b8db',
                brightWhite: '#e5e5e5'
            },
            scrollback: 10000,
            tabStopWidth: 4,
        });

        // Add fit addon to auto-resize terminal
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        // Add web links addon for clickable URLs
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        term.loadAddon(webLinksAddon);

        // Open terminal in container
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        // Handle window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
        });

        // WebSocket connection
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/terminal`;
        const socket = new WebSocket(wsUrl);

        const statusEl = document.getElementById('connection-status');

        socket.addEventListener('open', () => {
            statusEl.textContent = 'Connected';
            statusEl.className = 'connection-status connected';

            // Hide status after 2 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 2000);

            // Send terminal size
            socket.send(JSON.stringify([
                'set_size',
                term.rows,
                term.cols,
                window.innerHeight,
                window.innerWidth
            ]));

            // Auto-start chat if enabled
            if (AUTO_START_CHAT) {
                // Wait a bit for shell to be ready, then send command
                setTimeout(() => {
                    socket.send(JSON.stringify([
                        'stdin',
                        `./mixvllm-chat --base-url ${MODEL_SERVER_URL}\n`
                    ]));
                }, 500);
            }
        });

        socket.addEventListener('close', () => {
            term.write('\r\n\r\n\x1b[31m[Connection closed]\x1b[0m\r\n');
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'connection-status error';
            statusEl.style.display = 'block';
        });

        socket.addEventListener('error', (error) => {
            console.error('WebSocket error:', error);
            statusEl.textContent = 'Connection Error';
            statusEl.className = 'connection-status error';
            statusEl.style.display = 'block';
        });

        socket.addEventListener('message', (event) => {
            const msg = JSON.parse(event.data);

            if (msg[0] === 'stdout') {
                term.write(msg[1]);
            } else if (msg[0] === 'disconnect') {
                socket.close();
            }
        });

        // Send terminal input to server
        term.onData((data) => {
            socket.send(JSON.stringify(['stdin', data]));
        });

        // Handle terminal resize
        term.onResize(({ cols, rows }) => {
            socket.send(JSON.stringify([
                'set_size',
                rows,
                cols,
                window.innerHeight,
                window.innerWidth
            ]));
        });

        // Focus terminal on load
        term.focus();
    </script>
</body>
</html>
