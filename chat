#!/usr/bin/env bash
#
# chat â€“ launcher for the MixVLLM standalone chat client
# Always uses uv for environment management.
#
# Features:
#   * Default base-URL: http://localhost:8000
#   * Optional MCP integration via --enable-mcp
#   * Runs via `uv run` (no manual venv activation required)
#
# Usage:
#   ./chat [--base-url URL] [--enable-mcp] [--mcp-config FILE] [Other argsâ€¦]
#
set -euo pipefail

# ----------------------------------------------------------------- #
# 1. Defaults & setup                                               #
# ----------------------------------------------------------------- #
DEFAULT_BASE_URL="http://localhost:8000"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MCP_CONFIG_FILE="$SCRIPT_DIR/configs/mcp_servers.yaml"
APP_ENTRY="standalone/chat/chat_client_standalone.py"

# ----------------------------------------------------------------- #
# 2. Parse user arguments                                           #
# ----------------------------------------------------------------- #
ARGS=()
enable_mcp_provided=false

while (( $# )); do
    case "$1" in
        -h|--help)
            cat <<'EOF'
Usage: chat [--base-url URL] [--enable-mcp] [--mcp-config FILE] [Other argsâ€¦]

Options:
  --base-url URL        Override the default model server URL
  -m | --enable-mcp     Enable MCP mode (adds --mcp-config automatically)
  --mcp-config FILE     Path to the MCP config file (only used if --enable-mcp)
  -h | --help           Show this help text
EOF
            exit 0
            ;;
        --base-url)
            ARGS+=( "$1" "$2" )
            shift 2
            ;;
        -m|--enable-mcp)
            enable_mcp_provided=true
            ARGS+=( "$1" )
            shift
            ;;
        --mcp-config)
            ARGS+=( "$1" "$2" )
            shift 2
            ;;
        *)
            ARGS+=( "$1" )
            shift
            ;;
    esac
done

# ----------------------------------------------------------------- #
# 3. Inject defaults                                                #
# ----------------------------------------------------------------- #
if ! printf '%s\n' "${ARGS[@]}" | grep -q -- '--base-url'; then
    ARGS+=( "--base-url" "$DEFAULT_BASE_URL" )
fi

if $enable_mcp_provided; then
    if ! printf '%s\n' "${ARGS[@]}" | grep -q -- '--mcp-config'; then
        ARGS+=( "--mcp-config" "$MCP_CONFIG_FILE" )
    fi
fi

# ----------------------------------------------------------------- #
# 4. Launch using uv                                                #
# ----------------------------------------------------------------- #
cd "$SCRIPT_DIR"
echo "ðŸš€ Launching MixVLLM Chat via uv"
PYTHONPATH="$SCRIPT_DIR${PYTHONPATH:+:$PYTHONPATH}" \
    uv run python "$APP_ENTRY" "${ARGS[@]}"