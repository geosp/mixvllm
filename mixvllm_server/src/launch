#!/usr/bin/env bash
#!/usr/bin/env bash
# ------------------------------------------------------------
# launch ‚Äì wrapper that pulls the right YAML from the configs/ #
# directory and forwards everything to the mixvllm-serve cmd  #
# ------------------------------------------------------------
set -euo pipefail

# ---- 1. Default config directory --------------------------------
CONFIG_DIR=${CONFIG_DIR:-config}

# ---- 2. Make sure HF_TOKEN is exported -------------------------
if [[ -z "${HF_TOKEN:-}" ]]; then
  echo "‚ùå  HF_TOKEN is not set.  Export it first: export HF_TOKEN=‚Ä¶"
  exit 1
fi

# ---- 3. Parse arguments ----------------------------------------
MODEL=""
MODEL_SERVER_URL=""
TERMINAL_ONLY=false
ARGV=()

while (( $# )); do
  case "$1" in
    -m|--model) shift; MODEL="$1"; shift ;;
    --terminal-only)
      TERMINAL_ONLY=true
      shift
      ;;
    --model-server-url) shift; MODEL_SERVER_URL="$1"; shift ;;
    -h|--help)
      cat <<'EOF'
Usage: launch --model <n> [OPTIONS...]
       launch --terminal-only --model-server-url <url> [OPTIONS...]

Options:
  -m, --model              Name of the model (corresponds to a YAML file in "$CONFIG_DIR")
  --terminal-only          (deprecated) Run only the terminal server (no longer supported)
  --model-server-url URL   (deprecated) URL of external model server for terminal-only mode
  -h, --help               Show this help message
Any other options are passed through to the underlying mixvllm-serve command.

Examples:
  # Serve model
  ./launch --model gpt-oss-20b

EOF
      exit 0
      ;;
    # Remove web terminal options (no longer supported)
    --) shift; ARGV+=("$@"); break ;;
    *) ARGV+=("$1"); shift ;;
  esac
done

# ---- 4. Handle missing model ------------------------------------
if [[ "$TERMINAL_ONLY" = true ]]; then
  # Terminal-only mode: require model server URL
  if [[ -z "$MODEL_SERVER_URL" ]]; then
    echo "‚ùå  --model-server-url is required when using --terminal-only" >&2
    exit 1
  fi
else
  # Normal mode: require model
  if [[ -z "$MODEL" ]]; then
    echo "‚ùå  No model specified." >&2
    echo "You must provide --model <n>." >&2

    # list available models
    if [[ -d "$CONFIG_DIR" ]]; then
      echo "‚ùì  Available models:" >&2
      find "$CONFIG_DIR" -maxdepth 1 -name '*.yaml' 2>/dev/null |
        while IFS= read -r f; do
          base="${f##*/}"
          base="${base%.yaml}"
          [[ "$base" == "mcp_servers" ]] && continue
          echo "      ‚Ä¢ $base" >&2
        done
    else
      echo "‚ö†Ô∏è  Config directory '$CONFIG_DIR' does not exist." >&2
    fi
    exit 1
  fi
fi

# ---- 5. Execute ---------------------------------------------
CONFIG="$CONFIG_DIR/${MODEL}.yaml"

  if [[ ! -f "$CONFIG" ]]; then
    echo "‚ùå  No config file found for model '$MODEL' (expected '$CONFIG') in directory '$CONFIG_DIR'" >&2
    exit 1
  fi

echo "üöÄ  Launching mixvllm-serve with model '$MODEL' ‚Üí $CONFIG"
exec uv run mixvllm-serve --config "$CONFIG" "${ARGV[@]}"